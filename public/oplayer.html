<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Quiz Player</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .correct { background-color: #059669 !important; }
    .incorrect { background-color: #dc2626 !important; }
    .selected { background-color: #facc15 !important; color: black; }
  </style>
</head>

<body class="bg-slate-950 text-white p-6">

<h1 class="text-2xl font-bold mb-4">PLAYER</h1>

<!-- ================= QUIZ SCREEN ================= -->
<div id="quiz-screen" class="flex gap-6">

  <!-- LEFT: QUESTION -->
  <div class="flex-1 space-y-4">
    <div id="q-text" class="bg-slate-800 p-4 rounded text-lg">
      Waiting for quiz to start...
    </div>

    <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

    <div class="flex items-center gap-4 mt-4">
      <span class="text-xl font-bold">‚è±</span>
      <span id="timer-text" class="text-3xl font-black">60s</span>
    </div>

    <button
      id="submit-btn"
      class="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded font-bold disabled:opacity-40"
      disabled
    >
      Submit Answer
    </button>
  </div>

  <!-- RIGHT: LEADERBOARD -->
  <div class="w-72 bg-slate-900 p-4 rounded-xl h-[500px] overflow-y-auto">
    <h2 class="text-xl font-bold mb-3 sticky top-0 bg-slate-900 pb-2">
      üèÜ Leaderboard
    </h2>
    <div id="rankings" class="space-y-2"></div>
  </div>

</div>

<!-- ================= END SCREEN ================= -->
<div id="end-screen" class="hidden text-center mt-10">
  <div class="text-7xl mb-4 animate-bounce">üëë</div>
  <h2 class="text-4xl font-black mb-2">Winner</h2>
  <div id="final-champ" class="text-6xl font-black text-yellow-400"></div>
</div>

<script src="/socket.io/socket.io.js"></script>

<script>
const socket = io();

let playerName = prompt("Enter your name") || "Guest";
let currentIdx = 0;
let selectedIdx = null;
let canSubmit = false;

/* ================= JOIN ================= */
socket.emit("joinRoom", { name: playerName });

/* ================= QUESTION ================= */
socket.on("questionUpdate", data => {
  currentIdx = data.index;
  selectedIdx = null;
  canSubmit = true;

  document.getElementById("quiz-screen").style.display = "flex";
  document.getElementById("end-screen").style.display = "none";

  document.getElementById("submit-btn").disabled = true;
  document.getElementById("q-text").innerText = data.question.q;
  document.getElementById("timer-text").innerText = "60s";

  const grid = document.getElementById("options-grid");
  grid.innerHTML = "";

  data.question.o.forEach((opt, i) => {
    const btn = document.createElement("button");
    btn.innerText = opt;
    btn.className = "bg-slate-800 hover:bg-slate-700 p-4 rounded";
    btn.onclick = () => selectOption(i, btn);
    grid.appendChild(btn);
  });
});

/* ================= TIMER ================= */
socket.on("timerUpdate", time => {
  document.getElementById("timer-text").innerText = `${time}s`;

  if (time <= 0) {
    canSubmit = false;
    document.getElementById("submit-btn").disabled = true;
  }
});

/* ================= SUBMIT ================= */
document.getElementById("submit-btn").onclick = () => {
  if (!canSubmit || selectedIdx === null) return;

  socket.emit("submitAnswer", {
    questionIdx: currentIdx,
    selectedIdx
  });

  canSubmit = false;
  document.getElementById("submit-btn").disabled = true;
};

/* ================= SELECT OPTION ================= */
function selectOption(idx, btn) {
  if (!canSubmit) return;

  selectedIdx = idx;
  document.getElementById("submit-btn").disabled = false;

  [...document.getElementById("options-grid").children]
    .forEach(b => b.classList.remove("selected"));

  btn.classList.add("selected");
}

/* ================= REVEAL ANSWER ================= */
socket.on("revealAnswer", ({ correctIdx }) => {
  const grid = document.getElementById("options-grid").children;

  [...grid].forEach((btn, i) => {
    btn.disabled = true;
    if (i === correctIdx) btn.classList.add("correct");
    else if (i === selectedIdx) btn.classList.add("incorrect");
  });
});

/* ================= LEADERBOARD (FIXED) ================= */
socket.on("leaderboardUpdate", playersObj => {
  const list = document.getElementById("rankings");
  list.innerHTML = "";

  const sorted = Object.values(playersObj)
    .sort((a, b) => b.score - a.score); // ‚úÖ score-based

  sorted.forEach((p, i) => {
    list.innerHTML += `
      <div class="flex justify-between items-center p-2 rounded
        ${i === 0 ? 'bg-yellow-500/20 border border-yellow-400' : 'bg-slate-800 border border-slate-700'}">
        <div class="flex gap-2 truncate">
          <span class="font-black">${i + 1}</span>
          <span class="truncate">${p.name}</span>
        </div>
        <span class="font-mono text-blue-400">${p.score}</span>
      </div>
    `;
  });
});

/* ================= END QUIZ ================= */
socket.on("quizEnded", ({ players }) => {
  document.getElementById("quiz-screen").style.display = "none";
  document.getElementById("end-screen").style.display = "block";

  const winner = Object.values(players)
    .sort((a, b) => b.score - a.score)[0];

  document.getElementById("final-champ").innerText = winner.name;
});
</script>

</body>
</html>
